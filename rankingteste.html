<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Ranking - Coaliz√£o 016</title>
    
    <link rel="stylesheet" href="styles.css" />

    <style>
        /* Estilos para a p√°gina de Ranking */
        .ranking-container { max-width: 900px; margin: 0 auto; padding: 20px; text-align: center; }
        .explicacao { background-color: #222; border-radius: 10px; padding: 30px; margin-bottom: 40px; }
        .explicacao h2 { margin-top: 0; color: #ff8c00; }
        .explicacao p { color: #ccc; line-height: 1.6; font-size: 1.1em; }
        
        /* Estilos do Regulamento Expans√≠vel */
        .regulamento-container {
            background-color: #282828;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 40px;
            text-align: left;
        }
        .regulamento-container details { border: 1px solid #444; border-radius: 5px; padding: 15px; }
        .regulamento-container summary {
            font-weight: bold;
            color: #ff8c00;
            font-size: 1.2em;
            cursor: pointer;
            outline: none;
        }
        .regulamento-container .regulamento-content { margin-top: 20px; line-height: 1.7; color: #e0e0e0; }
        .regulamento-container .regulamento-content h3 { color: #fff; border-bottom: 1px solid #444; padding-bottom: 5px; margin-top: 30px; }
        .regulamento-container .regulamento-content ul, .regulamento-container .regulamento-content ol { padding-left: 20px; }

        /* Estilos da Tabela de Ranking */
        .ranking-table-container { background-color: #282828; padding: 20px; border-radius: 10px; }
        .ranking-table-container h2 { color: #fff; }
        #ranking-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #ranking-table thead { background-color: #1a1a1a; }
        #ranking-table th { padding: 15px; color: #ff8c00; text-align: left; }
        #ranking-table td { padding: 15px; color: #e0e0e0; text-align: left; border-top: 1px solid #333; }
        #ranking-table tbody tr:nth-child(even) { background-color: #222; }
        #ranking-table tbody tr:hover { background-color: #383838; }
        #ranking-table .posicao { font-weight: bold; font-size: 1.2em; text-align: center; width: 60px; }
        #ranking-table .mc-nome { font-weight: bold; color: #fff; }
        #ranking-table .mc-pontos { font-weight: bold; color: #ff8c00; text-align: right; }
    </style>
</head>
<body>
    <header>
    </header>

    <nav>
        <div class="hamburger">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </div>
        <div class="nav-links">
            <a href="index.html">In√≠cio</a>
            <a href="batalhas.html">Batalhas</a>
            <a href="mcs.html">MC's</a>
            <a href="mapaindex.html">Mapa</a>
            <a href="ranking.html"><strong>Ranking</strong></a>
            <div class="dropdown">
                <a href="#" class="dropdown-label">Nossas Redes</a>
                <div class="dropdown-content">
                    <a href="https://www.instagram.com/coalizao016/" target="_blank">Instagram</a>
                    <a href="https://www.tiktok.com/@coalizao016?lang=pt-BR" target="_blank">TikTok</a>
                    <a href="https://www.youtube.com/@Coaliz%C3%A3o016" target="_blank">YouTube</a>
                    <a href="https://linktr.ee/coalizao016" target="_blank">Fotos</a>
                </div>
            </div>
        </div>
    </nav>
    
    <div class="ranking-container">
        <h1>Ranking Oficial da Liga</h1>
        
        <div class="explicacao">
            <h2>A Liga Come√ßou!</h2>
            <p>
                A Liga Caipira de Freestyle est√° no ar! A partir de agora, esta p√°gina ser√° atualizada regularmente com a pontua√ß√£o e as estat√≠sticas de todos os MCs, com a precis√£o do <strong>TwolalaScore</strong>. Fique de olho para acompanhar a nova fase do Freestyle do interior!
            </p>
        </div>

        <div class="regulamento-container">
            <details>
                <summary>Clique para ver o Regulamento Completo (v1.2)</summary>
                <div class="regulamento-content">
                    <h3>6) Sistema de Pontua√ß√£o</h3>
                    <p><strong>a) Pontua√ß√£o Base por Coloca√ß√£o</strong></p>
                    <ul>
                        <li>ü•á Campe√£o: **10 pontos**</li>
                        <li>ü•à Vice-Campe√£o: **7 pontos**</li>
                        <li>üèÖ Semifinalistas (3¬∫ e 4¬∫): **5 pontos**</li>
                        <li>ü•ä Participa√ß√£o (entrou na chave): **2 pontos**</li>
                    </ul>
                    <p><strong>b) Pontos B√¥nus</strong></p>
                    <ul>
                        <li>‚úàÔ∏è B√¥nus de Viagem: **+1 ponto** para o MC que competir fora da sua cidade.</li>
                        <li>‚≠ê B√¥nus de Twolala: **+1 ponto** para o MC que vencer qualquer confronto por 2x0.</li>
                    </ul>
                </div>
            </details>
        </div>

        <div class="ranking-table-container" id="ranking-container-id">
            <h2>Ranking Geral (Temporada)</h2>
            <div id="loader" style="color: #ccc; padding: 30px 0;">Carregando ranking...</div>
            <table id="ranking-table" style="display:none;">
                <thead>
                    <tr>
                        <th class="posicao">#</th>
                        <th>MC</th>
                        <th class="mc-pontos">Pontos</th>
                    </tr>
                </thead>
                <tbody id="ranking-body"></tbody>
            </table>
        </div>
    </div>
    
    <footer>
        ¬© 2025 Coaliz√£o 016 - Todos os direitos reservados.
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // 1. Configura a conex√£o
        const SUPABASE_URL = 'https://rxensjzxouyczhpftdpb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4ZW5zanp4b3V5Y3pocGZ0ZHBiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNTI5MDUsImV4cCI6MjA3NDkyODkwNX0.__J26I9DvvFiJY63EnOgP5DHbKoxQrFYou1TKh1ualk';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // -------------------------------------------------------------
        // L√≥gica do Ranking (Apenas Leitura e C√°lculo)
        // -------------------------------------------------------------

        document.addEventListener('DOMContentLoaded', async () => {
            
            // L√≥gica do Menu Hamburger (Mantida)
            const hamburger = document.querySelector(".hamburger");
            const navLinks = document.querySelector(".nav-links");
            if (hamburger && navLinks) {
                hamburger.addEventListener("click", () => navLinks.classList.toggle("active"));
            }

            const rankingContainer = document.getElementById('ranking-container-id');
            const loader = document.getElementById('loader');
            const table = document.getElementById('ranking-table');
            const rankingBody = document.getElementById('ranking-body');

            // 3. Busca os dados
            const { data: mcs, error: mcsError } = await supabaseClient.from('mcs').select('*');
            const { data: logBatalhas, error: logError } = await supabaseClient.from('log_batalhas').select('*');

            if (mcsError || logError) {
                loader.style.display = 'none';
                rankingContainer.innerHTML = '<h2>Erro ao carregar dados. Verifique o console (F12).</h2>';
                console.error(mcsError || logError);
                return;
            }

            // Mensagem caso a tabela de log esteja vazia
            if (logBatalhas.length === 0) {
                loader.style.display = 'none';
                rankingContainer.innerHTML = '<h2>Ranking Geral (Temporada)</h2><p style="color: #ccc; padding: 30px 0;">O ranking ser√° exibido aqui ap√≥s o cadastro dos primeiros resultados na Supabase.</p>';
                return;
            }

            // 4. CALCULA AS ESTAT√çSTICAS PARA CADA MC
            const mcMap = new Map();
            mcs.forEach(mc => {
                if (!mc.id.startsWith('TEMP')) {
                     mcMap.set(mc.id, { ...mc, estatisticas: { pontos: 0 } });
                }
            });

            logBatalhas.forEach(confronto => {
                // Garante que todos os MCs envolvidos existam no mapa
                [confronto.mc1_id, confronto.mc2_id].forEach(mcId => {
                    if (!mcMap.has(mcId)) {
                        mcMap.set(mcId, { id: mcId, nome: `MC Tempor√°rio (${mcId})`, estatisticas: { pontos: 0 } });
                    }
                });

                // L√≥gica de pontua√ß√£o
                [confronto.mc1_id, confronto.mc2_id].forEach(mcId => {
                    const mc = mcMap.get(mcId);
                    if (!mc || mcId.startsWith('TEMP')) return; // Ignora IDs tempor√°rios

                    let pontosGanhos = 0;
                    let fase = confronto.fase.toLowerCase();
                    let pontuacaoColocacao = 0;

                    if (fase.includes('final')) {
                        pontuacaoColocacao = (confronto.vencedor_id === mcId) ? 10 : 7;
                    } else if (fase.includes('semi')) {
                        pontuacaoColocacao = 5;
                    } else if (fase.includes('quartas') || fase.includes('oitavas')) {
                        pontuacaoColocacao = 2; // Pontua√ß√£o de participa√ß√£o
                    }
                    
                    // 1. Soma a pontua√ß√£o de coloca√ß√£o m√°xima (10, 7, 5 ou 2)
                    if (pontuacaoColocacao > 0) {
                        pontosGanhos += pontuacaoColocacao;
                    }

                    // 2. Soma o ponto de b√¥nus (+1)
                    if (confronto.placar === '2x0' && confronto.vencedor_id === mcId && (fase.includes('oitavas') || fase.includes('quartas'))) {
                        // A l√≥gica de inser√ß√£o pressup√µe que os b√¥nus (+1) s√£o inseridos como Oitavas 2x0.
                        // Se o ponto de coloca√ß√£o for 2, pode ser uma participa√ß√£o OU um b√¥nus.
                        // Como a inser√ß√£o √© separada, basta somar o +1, mas vamos usar a checagem:
                        if (pontuacaoColocacao === 2) { 
                            pontosGanhos += 1; // +1 ponto Twolala ou Viagem
                        }
                    }
                    
                    // Acumula os pontos
                    mc.estatisticas.pontos += pontosGanhos;
                });
            });

            // 5. Ordena e exibe a tabela
            const mcsOrdenados = Array.from(mcMap.values())
                .filter(mc => mc.estatisticas.pontos > 0)
                .sort((a, b) => b.estatisticas.pontos - a.estatisticas.pontos);
            
            rankingBody.innerHTML = '';
            
            if (mcsOrdenados.length > 0) {
                const rankingFinal = mcsOrdenados.filter(mc => !mc.id.startsWith('TEMP') || mc.estatisticas.pontos > 0);
                
                rankingFinal.forEach((mc, index) => {
                    if (mc.id.startsWith('TEMP') && mc.estatisticas.pontos <= 0) return;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="posicao">${index + 1}</td>
                        <td class="mc-nome">${mc.nome}</td>
                        <td class="mc-pontos">${mc.estatisticas.pontos}</td>
                    `;
                    rankingBody.appendChild(row);
                });
                table.style.display = 'table';
            } else {
                rankingContainer.innerHTML = '<h2>Ranking Geral (Temporada)</h2><p style="color: #ccc; padding: 30px 0;">N√£o h√° resultados v√°lidos para exibi√ß√£o.</p>';
            }

            loader.style.display = 'none';
        });
    </script>
</body>
</html>