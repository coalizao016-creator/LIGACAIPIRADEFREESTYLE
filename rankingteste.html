<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Ranking (TESTE) - Coalizão 016</title>
    
    <link rel="stylesheet" href="styles.css" />

    <style>
        /* Estilos específicos da página de Ranking */
        .ranking-container { 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 20px; 
            text-align: center; 
        }
        .ranking-table-container { 
            background-color: #282828; 
            padding: 20px; 
            border-radius: 10px; 
            margin-top: 30px;
        }
        .ranking-table-container h2 { 
            color: #fff; 
        }
        #ranking-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
        }
        #ranking-table thead { 
            background-color: #1a1a1a; 
        }
        /* ATENÇÃO: Novas colunas adicionadas */
        #ranking-table th { 
            padding: 15px; 
            color: #ff8c00; 
            text-align: left; 
        }
        #ranking-table td { 
            padding: 15px; 
            color: #e0e0e0; 
            text-align: left; 
            border-top: 1px solid #333; 
        }
        #ranking-table tbody tr:nth-child(even) { 
            background-color: #222; 
        }
        #ranking-table .posicao { 
            font-weight: bold; 
            font-size: 1.2em; 
            text-align: center; 
            width: 60px; 
        }
        #ranking-table .mc-nome { 
            font-weight: bold; 
            color: #fff; 
        }
        #ranking-table .mc-pontos { 
            font-weight: bold; 
            color: #ff8c00; 
            text-align: right; 
        }
    </style>
</head>
<body>
    <header>
    </header>
    
    <nav>
        <div class="hamburger">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </div>
        <div class="nav-links">
            <a href="index.html">Início</a>
            <a href="batalhas.html">Batalhas</a>
            <a href="mcs.html">MC's</a>
            <a href="mapaindex.html">Mapa</a>
            <a href="ranking.html">Ranking</a>
            <div class="dropdown">
                <a href="#" class="dropdown-label">Nossas Redes</a>
                <div class="dropdown-content">
                    <a href="https://www.instagram.com/coalizao016/" target="_blank">Instagram</a>
                    <a href="https://www.tiktok.com/@coalizao016?lang=pt-BR" target="_blank">TikTok</a>
                    <a href="https://www.youtube.com/@Coaliz%C3%A3o016" target="_blank">YouTube</a>
                    <a href="https://linktr.ee/coalizao016" target="_blank">Fotos</a>
                </div>
            </div>
        </div>
    </nav>
    
    <div class="ranking-container">
        <h1>Página de Teste do Ranking</h1>
        <p style="color: #ccc;">Esta página conecta-se diretamente ao seu banco de dados Supabase para testes.</p>

        <div class="ranking-table-container" id="ranking-container-id">
            <h2>Ranking Geral (Temporada)</h2>
            <div id="loader" style="color: #ccc; padding: 30px 0;">Carregando ranking...</div>
            <table id="ranking-table" style="display:none;">
                <thead>
                    <tr>
                        <th class="posicao">#</th>
                        <th>MC</th>
                        <th class="mc-pontos">Total Pontos</th>
                        <th class="mc-pontos">Bônus 2x0</th>
                        <th class="mc-pontos">Viagens</th>
                    </tr>
                </thead>
                <tbody id="ranking-body"></tbody>
            </table>
        </div>
    </div>
    
    <footer>
        © 2025 Coalizão 016 - Todos os direitos reservados.
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // 1. CONFIGURAÇÃO SUPABASE
        const SUPABASE_URL = 'https://rxensjzxouyczhpftdpb.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4ZW5zanp4b3V5Y3pocGZ0ZHBiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNTI5MDUsImV4cCI6MjA3NDkyODkwNX0.__J26I9DvvFiJY63EnOgP5DHbKoxQrFYou1TKh1ualk'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); 

        // Lógica principal da página
        document.addEventListener('DOMContentLoaded', async () => {
            
            // Lógica do Menu Hamburger
            const hamburger = document.querySelector(".hamburger");
            const navLinks = document.querySelector(".nav-links");
            if (hamburger && navLinks) {
                hamburger.addEventListener("click", () => navLinks.classList.toggle("active"));
            }

            const rankingContainer = document.getElementById('ranking-container-id');
            const loader = document.getElementById('loader');
            const table = document.getElementById('ranking-table');
            const rankingBody = document.getElementById('ranking-body');

            // Busca os MCs e os Logs (Confrontos e Viagens)
            const { data: mcs, error: mcsError } = await supabaseClient.from('mcs').select('*');
            const { data: logBatalhas, error: logError } = await supabaseClient.from('log_batalhas').select('*'); 
            const { data: logViagens, error: viagemError } = await supabaseClient.from('log_viagens').select('*');


            if (mcsError || logError || viagemError) {
                rankingContainer.innerHTML = '<h2>Erro ao carregar dados. Verifique o console (F12) e as políticas RLS.</h2>';
                console.error("Erro ao carregar MCs:", mcsError);
                console.error("Erro ao carregar Logs de Batalha:", logError);
                console.error("Erro ao carregar Logs de Viagem:", viagemError);
                return;
            }

            if (logBatalhas.length === 0 && logViagens.length === 0) {
                loader.style.display = 'none';
                rankingContainer.innerHTML = '<h2>Ranking Geral (Temporada)</h2><p style="color: #ccc; padding: 30px 0;">Nenhum resultado cadastrado. Cadastre o primeiro resultado e recarregue a página.</p>';
                return;
            }

            // Estrutura para calcular a pontuação máxima e bônus
            const mcScores = {}; 
            mcs.forEach(mc => {
                const mcIdString = String(mc.id);
                mcScores[mcIdString] = { 
                    max_points: 0, 
                    total_bonus_2x0: 0, 
                    total_viagem: 0 
                }; 
            });

            // 1. CÁLCULO DE PONTOS DE BATALHA: Encontra a Pontuação Máxima e Soma os Bônus
            logBatalhas.forEach(confronto => {
                
                // 1A. Determina a lista de IDs de VENCEDORES (Prioriza o novo campo, mas cai de volta para o antigo)
                const vencedorIds = (confronto.vencedor_ids && confronto.vencedor_ids.length > 0) 
                                   ? confronto.vencedor_ids.map(String) // Novo log de equipe
                                   : (confronto.vencedor_id ? [String(confronto.vencedor_id)] : []); // Log antigo 1x1

                // 1B. Determina a lista de IDs de TODOS os PARTICIPANTES (Prioriza o novo campo, mas cai de volta para os antigos mc1/mc2)
                let participantesIds = [];
                if (confronto.participantes_ids && confronto.participantes_ids.length > 0) {
                    participantesIds = confronto.participantes_ids.map(String); // Novo log de equipe
                } else {
                    // Log antigo 1x1 (inclui somente MC1 e MC2, filtrando nulos)
                    if (confronto.mc1_id) participantesIds.push(String(confronto.mc1_id));
                    if (confronto.mc2_id) participantesIds.push(String(confronto.mc2_id));
                }

                // Itera sobre todos os participantes encontrados para atribuir pontos
                participantesIds.forEach(mcIdString => {
                    
                    if (mcScores[mcIdString]) { // Garante que o MC existe
                        let currentMatchScore = 0;
                        
                        // Verifica se o MC está na lista de vencedores
                        let isWinner = vencedorIds.includes(mcIdString);

                        // Determina a pontuação BASE do confronto
                        if (confronto.fase.toLowerCase().includes('final')) {
                            // Se o MC está na lista de vencedores da final
                            currentMatchScore = isWinner ? 10 : 7; // Campeão: 10, Vice: 7
                        } else if (confronto.fase.toLowerCase().includes('semi')) {
                            currentMatchScore = 5; // Semifinalista
                        } else {
                            currentMatchScore = 2; // Participação/Rodada
                        }

                        // A pontuação final de batalha é o MÁXIMO alcançado.
                        mcScores[mcIdString].max_points = Math.max(mcScores[mcIdString].max_points, currentMatchScore);

                        // O bônus 2x0 é somado para cada partida em que o MC vencedor participa (cumulativo)
                        if (isWinner && confronto.placar && confronto.placar.includes('x0')) {
                            mcScores[mcIdString].total_bonus_2x0 += 1;
                        }
                    }
                });
            });

            // 2. CÁLCULO DE PONTOS DE VIAGEM (Cumulativo)
            logViagens.forEach(logViagem => {
                const mcIdString = String(logViagem.mc_id);
                if (mcScores[mcIdString]) {
                    mcScores[mcIdString].total_viagem += logViagem.pontos_viagem; 
                }
            });
            
            // 3. FINALIZAÇÃO E ATRIBUIÇÃO DOS PONTOS (Armazenando detalhes do bônus)
            const mcsComPontos = mcs.map(mc => {
                const mcIdString = String(mc.id);
                const stats = mcScores[mcIdString] || { max_points: 0, total_bonus_2x0: 0, total_viagem: 0 };
                
                const totalPontos = stats.max_points + stats.total_bonus_2x0 + stats.total_viagem;

                mc.estatisticas = {
                    pontos: totalPontos, 
                    bonus_2x0: stats.total_bonus_2x0, // NOVO: Bônus 2x0
                    viagem: stats.total_viagem // NOVO: Pontos de Viagem
                };
                return mc;
            });

            // Ordena a lista
            const mcsOrdenados = mcsComPontos.sort((a, b) => b.estatisticas.pontos - a.estatisticas.pontos);
            
            rankingBody.innerHTML = '';
            mcsOrdenados.forEach((mc, index) => {
                // Só mostra MCs que pontuaram
                if (mc.estatisticas.pontos > 0) {
                    const row = document.createElement('tr');
                    // ALTERAÇÃO AQUI: NOVOS CAMPOS NA LINHA
                    row.innerHTML = `
                        <td class="posicao">${index + 1}</td>
                        <td class="mc-nome">${mc.nome}</td>
                        <td class="mc-pontos">${mc.estatisticas.pontos}</td>
                        <td class="mc-pontos">${mc.estatisticas.bonus_2x0}</td>
                        <td class="mc-pontos">${mc.estatisticas.viagem}</td>
                    `;
                    rankingBody.appendChild(row);
                }
            });

            loader.style.display = 'none';
            table.style.display = 'table';
        });
    </script>
</body>
</html>