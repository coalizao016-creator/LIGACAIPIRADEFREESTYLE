<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Log Manual - Coalizão 016</title>
    
    <link rel="stylesheet" href="styles.css" />

    <style>
        /* Estilos específicos */
        body { background-color: #1a1a1a; color: #fff; font-family: Arial, sans-serif; }
        .log-container { max-width: 600px; margin: 40px auto; padding: 30px; background-color: #282828; border-radius: 10px; }
        .log-container h1 { color: #ff8c00; text-align: center; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; position: relative; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #ccc; }
        .form-group input, .form-group select { 
            width: 100%; 
            padding: 10px; 
            border-radius: 5px; 
            border: 1px solid #444; 
            background-color: #333; 
            color: #fff; 
            box-sizing: border-box; 
        }
        /* Ajuste para o campo de data (Chrome/Edge/etc) */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1); /* Deixa o ícone do calendário branco */
        }

        .autocomplete-list { 
            border: 1px solid #444; 
            max-height: 150px; 
            overflow-y: auto; 
            background-color: #333; 
            border-radius: 5px; 
            position: absolute; 
            width: 100%; 
            z-index: 100;
        }
        .autocomplete-list div { 
            padding: 10px; 
            cursor: pointer; 
            color: #fff; 
        }
        .autocomplete-list div:hover { 
            background-color: #444; 
        }
        button { 
            width: 100%; 
            padding: 12px; 
            background-color: #ff8c00; 
            color: #111; 
            border: none; 
            border-radius: 5px; 
            font-size: 1.1em; 
            cursor: pointer; 
            transition: background-color 0.3s; 
            font-weight: bold;
        }
        button:hover { 
            background-color: #e67300; 
        }
        .mc-fields-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .mc-group {
            border: 1px solid #444;
            padding: 15px;
            border-radius: 8px;
            background-color: #333;
        }
        .mc-group h3 {
            color: #ff8c00;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .mc-field {
            display: none; 
        }
    </style>
</head>
<body>
    <header>
    </header>

    <div class="log-container">
        <h1>Log de Resultados Manuais</h1>
        
        <form id="log-form">

            <div class="form-group">
                <label for="batalha_nome">Batalha:</label>
                <input type="text" id="batalha_nome" required autocomplete="off" placeholder="Digite o nome da batalha"/>
                <input type="hidden" id="batalha_id" name="batalha_id"/>
                <div id="batalha_list" class="autocomplete-list"></div>
            </div>

            <div class="form-group">
                <label for="tipo_batalha">Tipo de Batalha:</label>
                <select id="tipo_batalha" required>
                    <option value="1x1">1 vs 1 (Individual)</option>
                    <option value="2x2">2 vs 2 (Duplas)</option>
                    <option value="3x3">3 vs 3 (Trios)</option>
                    <option value="4x4">4 vs 4 (Equipes)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="fase">Fase:</label>
                <select id="fase" required>
                    <option value="">Selecione a Fase</option>
                    <option value="PRIMEIRA">PRIMEIRA</option>
                    <option value="SEGUNDA">SEGUNDA</option>
                    <option value="SEMI">SEMI</option>
                    <option value="FINAL">FINAL</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="data_confronto_input">Data do Confronto (Realização):</label>
                <input type="date" id="data_confronto_input" required />
            </div>
            <div class="mc-fields-container">
                
                <div id="mc-group-1" class="mc-group">
                    <h3>MC's Equipe 1</h3>
                    <div class="form-group mc-field mc1_field">
                        <label for="mc1_nome">MC 1 (Equipe 1):</label>
                        <input type="text" id="mc1_nome" class="mc-input" required autocomplete="off"/>
                        <input type="hidden" id="mc1_id" name="mc1_id"/>
                        <div id="mc1_list" class="autocomplete-list"></div>
                    </div>
                    <div class="form-group mc-field mc2_field">
                        <label for="mc2_nome">MC 2 (Equipe 1):</label>
                        <input type="text" id="mc2_nome" class="mc-input" autocomplete="off"/>
                        <input type="hidden" id="mc2_id" name="mc2_id"/>
                        <div id="mc2_list" class="autocomplete-list"></div>
                    </div>
                    <div class="form-group mc-field mc3_field">
                        <label for="mc3_nome">MC 3 (Equipe 1):</label>
                        <input type="text" id="mc3_nome" class="mc-input" autocomplete="off"/>
                        <input type="hidden" id="mc3_id" name="mc3_id"/>
                        <div id="mc3_list" class="autocomplete-list"></div>
                    </div>
                    <div class="form-group mc-field mc4_field">
                        <label for="mc4_nome">MC 4 (Equipe 1):</label>
                        <input type="text" id="mc4_nome" class="mc-input" autocomplete="off"/>
                        <input type="hidden" id="mc4_id" name="mc4_id"/>
                        <div id="mc4_list" class="autocomplete-list"></div>
                    </div>
                </div>

                <div id="mc-group-2" class="mc-group">
                    <h3>MC's Equipe 2</h3>
                    <div class="form-group mc-field mc5_field">
                        <label for="mc5_nome">MC 1 (Equipe 2):</label>
                        <input type="text" id="mc5_nome" class="mc-input" required autocomplete="off"/>
                        <input type="hidden" id="mc5_id" name="mc5_id"/>
                        <div id="mc5_list" class="autocomplete-list"></div>
                    </div>
                    <div class="form-group mc-field mc6_field">
                        <label for="mc6_nome">MC 2 (Equipe 2):</label>
                        <input type="text" id="mc6_nome" class="mc-input" autocomplete="off"/>
                        <input type="hidden" id="mc6_id" name="mc6_id"/>
                        <div id="mc6_list" class="autocomplete-list"></div>
                    </div>
                    <div class="form-group mc-field mc7_field">
                        <label for="mc7_nome">MC 3 (Equipe 2):</label>
                        <input type="text" id="mc7_nome" class="mc-input" autocomplete="off"/>
                        <input type="hidden" id="mc7_id" name="mc7_id"/>
                        <div id="mc7_list" class="autocomplete-list"></div>
                    </div>
                    <div class="form-group mc-field mc8_field">
                        <label for="mc8_nome">MC 4 (Equipe 2):</label>
                        <input type="text" id="mc8_nome" class="mc-input" autocomplete="off"/>
                        <input type="hidden" id="mc8_id" name="mc8_id"/>
                        <div id="mc8_list" class="autocomplete-list"></div>
                    </div>
                </div>

            </div>
            
            <div class="form-group">
                <label for="placar">Placar:</label>
                <select id="placar" required>
                    <option value="2x1">2x1</option>
                    <option value="2x0">2x0</option>
                </select>
            </div>

            <div class="form-group">
                <label for="vencedor_id">Vencedor:</label>
                <select id="vencedor_id" required>
                    <option value="">Selecione a equipe vencedora</option>
                </select>
            </div>
            
            <button type="submit">Salvar Confronto</button>
            <p id="message" style="text-align: center; margin-top: 15px; color: #ff8c00;"></p>
        </form>

        <hr style="margin-top: 30px; border-color: #444;">

        <h2>Log de Bônus de Viagem (1 Ponto)</h2>
        <form id="viagem-form">
            <div class="form-group">
                <label for="viagem_mc_nome">MC Viajante:</label>
                <input type="text" id="viagem_mc_nome" class="mc-input" required autocomplete="off"/>
                <input type="hidden" id="viagem_mc_id" name="viagem_mc_id"/>
                <div id="viagem_mc_list" class="autocomplete-list"></div>
            </div>
             <div class="form-group">
                <label for="viagem_batalha_nome">Batalha em que Viajou:</label>
                <input type="text" id="viagem_batalha_nome" required autocomplete="off" placeholder="Digite o nome da batalha"/>
                <input type="hidden" id="viagem_batalha_id" name="viagem_batalha_id"/>
                <div id="viagem_batalha_list" class="autocomplete-list"></div>
            </div>
            <div class="form-group">
                <label for="viagem_data_confronto_input">Data da Viagem/Batalha:</label>
                <input type="date" id="viagem_data_confronto_input" required />
            </div>
            <button type="submit">Salvar Bônus de Viagem</button>
            <p id="viagem-message" style="text-align: center; margin-top: 15px; color: #ff8c00;"></p>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // 1. CONFIGURAÇÃO SUPABASE
        const SUPABASE_URL = 'https://rxensjzxouyczhpftdpb.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4ZW5zanp4b3V5Y3pocGZ0ZHBiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNTI5MDUsImV4cCI6MjA3NDkyODkwNX0.__J26I9DvvFiJY63EnOgP5DHbKoxQrFYou1TKh1ualk'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Variáveis globais
        let mcData = []; 
        let batalhaData = []; 

        // 2. FUNÇÃO GERAL DE AUTOCLASS
        function setupAutocomplete(inputElement, idElement, listElement, dataList, idKey = 'id', nameKey = 'nome') {
            inputElement.addEventListener('input', () => {
                const query = inputElement.value.toLowerCase();
                listElement.innerHTML = '';
                idElement.value = ''; 

                if (query.length < 2) return;

                const filtered = dataList.filter(item => item[nameKey] && item[nameKey].toLowerCase().includes(query));

                filtered.slice(0, 5).forEach(item => {
                    const div = document.createElement('div');
                    div.textContent = item[nameKey];
                    div.addEventListener('click', () => {
                        inputElement.value = item[nameKey];
                        idElement.value = item[idKey];
                        listElement.innerHTML = '';
                        
                        if (inputElement.classList.contains('mc-input')) {
                            updateVencedorOptions();
                        }
                    });
                    listElement.appendChild(div);
                });
            });

            inputElement.addEventListener('blur', () => {
                setTimeout(() => listElement.innerHTML = '', 200);
            });
        }


        // 3. ATUALIZAÇÃO DO VENCEDOR
        function updateVencedorOptions() {
            const vencedorSelect = document.getElementById('vencedor_id');
            const tipoBatalha = document.getElementById('tipo_batalha').value;
            const size = parseInt(tipoBatalha.charAt(0)); 

            vencedorSelect.innerHTML = '<option value="">Selecione a equipe vencedora</option>';

            const team1IDs = [];
            let team1Names = [];
            for (let i = 1; i <= size; i++) {
                const id = document.getElementById(`mc${i}_id`).value;
                const name = document.getElementById(`mc${i}_nome`).value;
                if (id) {
                    team1IDs.push(id);
                    team1Names.push(name);
                }
            }

            const team2IDs = [];
            let team2Names = [];
            for (let i = 5; i <= size + 4; i++) {
                const idElement = document.getElementById(`mc${i}_id`);
                const nameElement = document.getElementById(`mc${i}_nome`);
                
                if (idElement && nameElement) {
                    const id = idElement.value;
                    const name = nameElement.value;
                    
                    if (id) {
                        team2IDs.push(id);
                        team2Names.push(name);
                    }
                }
            }

            if (team1IDs.length === size && team2IDs.length === size) {
                
                const option1 = document.createElement('option');
                option1.value = team1IDs.join(',');
                option1.textContent = `Equipe 1 (${team1Names.join(' + ')})`;
                vencedorSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = team2IDs.join(',');
                option2.textContent = `Equipe 2 (${team2Names.join(' + ')})`;
                vencedorSelect.appendChild(option2);
            }
        }
        
        // 4. ATUALIZA VISIBILIDADE DOS CAMPOS
        function updateFieldsVisibility() {
            const tipoBatalha = document.getElementById('tipo_batalha').value;
            const size = parseInt(tipoBatalha.charAt(0)); 

            const requiredFields = [];
            for (let i = 1; i <= size; i++) { requiredFields.push(`mc${i}_nome`); }
            for (let i = 5; i <= size + 4; i++) { requiredFields.push(`mc${i}_nome`); }
            
            const allMcInputNames = ['mc1_nome', 'mc2_nome', 'mc3_nome', 'mc4_nome', 'mc5_nome', 'mc6_nome', 'mc7_nome', 'mc8_nome'];

            allMcInputNames.forEach(name => {
                const inputElement = document.getElementById(name);
                if (inputElement) {
                    const fieldGroup = inputElement.closest('.form-group');
                    const isRequired = requiredFields.includes(name);

                    if (isRequired) {
                        fieldGroup.style.display = 'block';
                        inputElement.required = true;
                    } else {
                        fieldGroup.style.display = 'none';
                        inputElement.required = false;
                        inputElement.value = ''; 
                        document.getElementById(`${name.split('_')[0]}_id`).value = '';
                    }
                }
            });
            
            updateVencedorOptions();
        }


        // 5. CARREGAMENTO INICIAL DE DADOS
        async function loadInitialData() {
            // A. Carregar MCs
            const { data: mcs, error: mcError } = await supabaseClient.from('mcs').select('*').order('nome', { ascending: true });
            if (!mcError) {
                mcData = mcs;
                
                for (let i = 1; i <= 8; i++) {
                    const input = document.getElementById(`mc${i}_nome`);
                    const id = document.getElementById(`mc${i}_id`);
                    const list = document.getElementById(`mc${i}_list`);
                    if (input) setupAutocomplete(input, id, list, mcData);
                }
                setupAutocomplete(document.getElementById('viagem_mc_nome'), document.getElementById('viagem_mc_id'), document.getElementById('viagem_mc_list'), mcData);
            } else {
                console.error("Erro ao carregar MCs:", mcError);
            }

            // B. Carregar Batalhas
            const { data: batalhas, error: batalhaError } = await supabaseClient.from('batalhas').select('*'); 
            
            const idKey = 'batalha_id'; 
            const nameKey = 'nome';

            if (!batalhaError) {
                batalhaData = batalhas;
                
                if (batalhas.length > 0 && !batalhas[0][idKey]) {
                    console.error(`Erro: Coluna '${idKey}' não encontrada. Por favor, verifique o nome da chave primária na tabela 'batalhas'.`);
                    document.getElementById('message').textContent = `ERRO: Nome da chave da Batalha incorreto. Verifique o console.`;
                    return;
                }

                setupAutocomplete(
                    document.getElementById('batalha_nome'), 
                    document.getElementById('batalha_id'), 
                    document.getElementById('batalha_list'), 
                    batalhaData,
                    idKey, 
                    nameKey
                );
                
                setupAutocomplete(
                    document.getElementById('viagem_batalha_nome'), 
                    document.getElementById('viagem_batalha_id'), 
                    document.getElementById('viagem_batalha_list'), 
                    batalhaData,
                    idKey, 
                    nameKey
                );

            } else {
                console.error("Erro ao carregar Batalhas:", batalhaError);
                document.getElementById('message').textContent = `ERRO 400 ao carregar Batalhas. Verifique o console. Detalhes: ${batalhaError.message || 'Erro de permissão RLS.'}`;
            }
            
            // C. Configuração inicial de visibilidade
            updateFieldsVisibility();
        }

        // 6. SUBMISSÃO DE FORMULÁRIO
        document.getElementById('log-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageElement = document.getElementById('message');
            messageElement.textContent = 'Salvando...';

            const batalha_id = document.getElementById('batalha_id').value; 
            const fase = document.getElementById('fase').value;
            const placar = document.getElementById('placar').value;
            const tipo_batalha = document.getElementById('tipo_batalha').value;
            // NOVO CAMPO DE DATA
            const data_confronto = document.getElementById('data_confronto_input').value;
            
            if (!batalha_id) {
                messageElement.textContent = 'ERRO: Selecione uma batalha válida usando o Autocompletar.';
                messageElement.style.color = 'red';
                return;
            }

            const vencedor_ids_string = document.getElementById('vencedor_id').value; 
            const vencedor_ids = vencedor_ids_string.split(',');

            const size = parseInt(tipo_batalha.charAt(0));
            const totalMCs = size * 2;
            const team1Ids = [];
            const team2Ids = [];
            
            for (let i = 1; i <= size; i++) {
                team1Ids.push(document.getElementById(`mc${i}_id`).value);
            }
            for (let i = 5; i <= size + 4; i++) {
                const idElement = document.getElementById(`mc${i}_id`);
                if (idElement) team2Ids.push(idElement.value);
            }
            const allMcIds = [...team1Ids, ...team2Ids].filter(id => id); 

            if (allMcIds.length !== totalMCs) {
                messageElement.textContent = `ERRO: Selecione exatamente ${totalMCs} MCs para o formato ${tipo_batalha}.`;
                messageElement.style.color = 'red';
                return;
            }

            // ESTRUTURA FINAL DO LOG COM AS DUAS DATAS
            const logData = {
                batalha_id: batalha_id,
                fase: fase,
                placar: placar,
                tipo_batalha: tipo_batalha, 
                mc1_id: team1Ids[0] || null, 
                mc2_id: team2Ids[0] || null, 
                vencedor_ids: vencedor_ids, 
                participantes_ids: allMcIds,
                vencedor_id: vencedor_ids[0] || null,
                // Data do Confronto (o que o usuário inseriu)
                data_confronto: data_confronto,
                // Data de Edição/Log (para corrigir o erro NOT NULL)
                data_edicao: new Date().toISOString() 
            };
            
            // NOTE: A coluna 'data_confronto' DEVE existir na sua tabela 'log_batalhas'. Se não existir, 
            // crie-a como tipo 'date' ou 'timestamp without time zone'.
            // Se o nome for diferente, altere `data_confronto` acima para o nome correto.

            const { error } = await supabaseClient
                .from('log_batalhas')
                .insert([logData]);

            if (error) {
                messageElement.textContent = `Falha ao salvar. Erro ao inserir logs de batalha: ${error.message}`;
                messageElement.style.color = 'red';
                console.error("Erro ao inserir log:", error);
            } else {
                messageElement.textContent = 'Confronto salvo com sucesso!';
                messageElement.style.color = 'green';
                document.getElementById('log-form').reset();
                updateFieldsVisibility(); 
                document.getElementById('batalha_id').value = ''; 
            }
        });
        
        // 7. SUBMISSÃO DE VIAGEM
        document.getElementById('viagem-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageElement = document.getElementById('viagem-message');
            messageElement.textContent = 'Salvando...';

            const mc_id = document.getElementById('viagem_mc_id').value;
            const batalha_id = document.getElementById('viagem_batalha_id').value; 
            const viagem_data_confronto = document.getElementById('viagem_data_confronto_input').value; // NOVA DATA
            
            if (!mc_id || !batalha_id || !viagem_data_confronto) {
                 messageElement.textContent = 'ERRO: Selecione o MC, a Batalha e a Data usando o Autocompletar.';
                 messageElement.style.color = 'red';
                 return;
            }

            const logViagemData = {
                mc_id: mc_id,
                batalha_id: batalha_id,
                data_confronto: viagem_data_confronto, // NOVO CAMPO
                pontos_viagem: 1
            };

            const { error } = await supabaseClient
                .from('log_viagens')
                .insert([logViagemData]);

            if (error) {
                messageElement.textContent = `Falha ao salvar. Erro ao inserir log de viagem: ${error.message}`;
                messageElement.style.color = 'red';
                console.error("Erro ao inserir log de viagem:", error);
            } else {
                messageElement.textContent = 'Bônus de Viagem salvo com sucesso!';
                messageElement.style.color = 'green';
                document.getElementById('viagem-form').reset();
                document.getElementById('viagem_mc_id').value = '';
                document.getElementById('viagem_batalha_id').value = '';
            }
        });


        // 8. LISTENERS GLOBAIS
        document.addEventListener('DOMContentLoaded', loadInitialData);
        
        document.getElementById('tipo_batalha').addEventListener('change', updateFieldsVisibility);

        document.querySelectorAll('.mc-input').forEach(input => {
            input.addEventListener('change', updateVencedorOptions);
        });

    </script>
</body>
</html>